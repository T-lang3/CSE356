<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPEG-DASH Player</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <style>
        body {
            height: 140vh;
            margin: 0;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        video {
            max-width: 640px;
            max-height: 360px;
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none; /* Hide all players initially */
        }
        #content {
            height: 1500px;
            padding: 20px;
            text-align: center;
            margin-top: 500px;
        }
        #preloader, #preloader2 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 24px;
            text-align: center;
            line-height: 100vh;
            z-index: 20;
        }
        #playPauseBtn{
            margin-top: 300px;
        }
    </style>
</head>
<body>
    <!--<div id="preloader">Loading next video...</div>
    <div id="preloader2">Preloading video after next...</div>-->
    
    <!-- Predefined video players (30 in total) -->
    <video id="videoPlayer1" controls></video>
    <video id="videoPlayer2" controls></video>
    <video id="videoPlayer3" controls></video>
    <video id="videoPlayer4" controls></video>
    <video id="videoPlayer5" controls></video>
    <video id="videoPlayer6" controls></video>
    <video id="videoPlayer7" controls></video>
    <video id="videoPlayer8" controls></video>
    <video id="videoPlayer9" controls></video>
    <video id="videoPlayer10" controls></video>
    <video id="videoPlayer11" controls></video>
    <video id="videoPlayer12" controls></video>
    <video id="videoPlayer13" controls></video>
    <video id="videoPlayer14" controls></video>
    <video id="videoPlayer15" controls></video>
    <video id="videoPlayer16" controls></video>
    <video id="videoPlayer17" controls></video>
    <video id="videoPlayer18" controls></video>
    <video id="videoPlayer19" controls></video>
    <video id="videoPlayer20" controls></video>
    <video id="videoPlayer21" controls></video>
    <video id="videoPlayer22" controls></video>
    <video id="videoPlayer23" controls></video>
    <video id="videoPlayer24" controls></video>
    <video id="videoPlayer25" controls></video>
    <video id="videoPlayer26" controls></video>
    <video id="videoPlayer27" controls></video>
    <video id="videoPlayer28" controls></video>
    <video id="videoPlayer29" controls></video>
    <video id="videoPlayer30" controls></video>

    <div id="content">
        <div id="playPauseBtn" onclick="togglePlayPause()">Pause</div>
        <button name="like" onclick="like(true)">like</button>
        <button name="dislike" onclick="like(false)">dislike</button>
        <select id="resolutionSelect" onchange="changeResolution()">
            <option value="">Select Resolution</option>
        </select>
        <p>Scroll down to change the video.</p>
    </div>

    <script>
        //let preloader = document.getElementById('preloader');
        //let preloader2 = document.getElementById('preloader2');
        let players = [];
        let videos = [];
        let videoQueue = [];
        let currentPlayerIndex = 0; // Current active player
        const totalPlayers = 30; // Fixed 30 players
        let historystack = []; // Stack to track the history of videos

        // Collect all the video players into an array
        for (let i = 1; i <= totalPlayers; i++) {
            let videoElement = document.getElementById(`videoPlayer${i}`);
            let player = dashjs.MediaPlayer().create();
            players.push(player);
            videos.push(videoElement);
        }

        var id_passed = "{{id}}";
        var username = "{{ username }}";
        var new_id = id_passed.replace('.mp4', '.mpd');
        var url = `/media/${new_id}`;

        // Initialize all players
        players.forEach((player, index) => {
            player.initialize(videos[index], url, true);
            player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function() {
                if (index === 0) {
                    //preloader.style.display = 'none';
                    populateResolutions();
                }
            });
        });

        function populateResolutions() {
            var resolutions = players[0].getBitrateInfoListFor('video');
            var resolutionSelect = document.getElementById('resolutionSelect');
            resolutions.forEach(function(resolution, index) {
                var option = document.createElement('option');
                option.value = index;
                option.text = `${resolution.width}x${resolution.height} - ${resolution.bitrate / 1000} kbps`;
                resolutionSelect.appendChild(option);
            });
        }

        function changeResolution() {
            var resolutionSelect = document.getElementById('resolutionSelect');
            var selectedIndex = resolutionSelect.value;
            if (selectedIndex) {
                players[currentPlayerIndex].setQualityFor('video', parseInt(selectedIndex, 10));
                players[currentPlayerIndex].play();
            } else {
                players[currentPlayerIndex].setAutoSwitchQualityFor('video', true);
            }
        }

        function togglePlayPause() {
            const currentVideo = videos[currentPlayerIndex];
            if (currentVideo.paused) {
                //videos[currentPlayerIndex].play();
                currentVideo.play();
                document.getElementById("playPauseBtn").innerHTML = "Pause";
            } else {
                //videos[currentPlayerIndex].pause();
                currentVideo.pause();
                document.getElementById("playPauseBtn").innerHTML = "Play";
            }
        }

        function like(val) {
            var currentUrl = window.location.href;
            var id = currentUrl.split('/').pop();
            fetch("{{ url_for('like') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'id': id,
                    'value': val,
                    'user': username
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Handle response data if needed
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        /*
        console.log("starts here");
        const response = fetch('/api/videos?count=20');  
        const videoFiles = response.json();
        videos = videoFiles.videos;
        let ids = videos.map(item => item.id);
        console.log("ids: "+ids);*/
        
        async function preloadNextVideos() {
            try {
                
                const response4 = await fetch('/api/videos?count=30');  
                let returnfile = await response4.json();
                //videos = returnfile.videos;
                //let ids = videos.map(item => item.id);
                //const videoFiles = ids.map(item => item+".mpd");
                

                const response = await fetch('/list_videos');
                const videoFiles = await response.json();
                
                //console.log("files: "+videoFiles);

                if (videoFiles.length > 0) {
                    videoQueue = [];
                    for (let i = 0; i < totalPlayers; i++) {
                        const randomIndex = Math.floor(Math.random() * videoFiles.length);
                        const videoUrl = `/media/${videoFiles[randomIndex]}`;
                        //console.log("video urls: "+videoUrl);
                        videoQueue.push(videoUrl);
                    }

                    // Preload videos for all players
                    for (let i = 0; i < totalPlayers; i++) {
                        //preloader2.style.display = 'block';
                        players[i].preload(videoQueue[i]);
                        console.log(`Video ${i + 1} preloaded:`, videoQueue[i]);
                    }
                    //preloader2.style.display = 'none';
                } else {
                    console.error('No .mpd videos found for preloading');
                }
            } catch (error) {
                console.error('Error preloading videos:', error);
            }
        }

        async function loadNextVideo() {
            //preloader.style.display = 'block';
            if (videoQueue.length > 0) {
                const nextVideoUrl = videoQueue.shift();
                var newUrl = `/play/${nextVideoUrl.replace('/media/', '')}`;
                window.history.replaceState({ path: newUrl }, '', newUrl);

                // Hide the current video and show the next player
                videos[currentPlayerIndex].style.display = 'none';

                // Push the current video URL to the history stack
                historystack.push(nextVideoUrl);

                // Switch to the next player in the cycle
                currentPlayerIndex = (currentPlayerIndex + 1) % totalPlayers;

                players[currentPlayerIndex].attachSource(nextVideoUrl);
                videos[currentPlayerIndex].style.display = 'block';
                players[currentPlayerIndex].play();
                preloadNextVideos();
            } else {
                console.error('No preloaded video available');
                //preloader.style.display = 'none';
            }
        }

        function handleScrollEvent(event) {
            if (event.deltaY > 0) {
                loadNextVideo();
            } else if (event.deltaY < 0) {
                // Scroll up: Load the previous video
                if (historystack.length > 1) {
                    historystack.pop(); // Remove the current video from history stack
                    const previousVideoUrl = historystack.pop(); // Get the previous video URL
                    var newUrl = `/play/${previousVideoUrl.replace('/media/', '')}`;
                    window.history.replaceState({ path: newUrl }, '', newUrl);

                    // Hide the current video and show the previous one
                    videos[currentPlayerIndex].style.display = 'none';

                    // Switch to the previous player
                    currentPlayerIndex = (currentPlayerIndex - 1 + totalPlayers) % totalPlayers;

                    players[currentPlayerIndex].attachSource(previousVideoUrl);
                    videos[currentPlayerIndex].style.display = 'block';
                    players[currentPlayerIndex].play();
                }
            }
        }

        function addScrollListener() {
            window.addEventListener('wheel', handleScrollEvent);
        }

        addScrollListener();
        preloadNextVideos();
    </script>
</body>
</html>



